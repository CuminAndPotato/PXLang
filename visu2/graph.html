<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/x-icon" href="https://production-assets.codepen.io/assets/favicon/favicon-8ea04875e70c4b0bb41da869e81236e54394d63638a1ef12fa558a4a835f1164.ico" />
    <link rel="mask-icon" type="" href="https://production-assets.codepen.io/assets/favicon/logo-pin-f2d2b6d2c61838f7e76325261b7195c27224080bc099486ddd6dccb469b8e8e6.svg" color="#111" />
    <title>CodePen - Redesigned - Company Employees Hierarchy Chart </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css'>
    <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Roboto'>

    <style>
        .full-container {
            background-color: red;
            width: 100%;
            height: 100%;
            font-family: 'Roboto', sans-serif;
        }


        /* ########################   DEPARTMENT INFO  ############################*/

        .department-information {
            font-family: 'Roboto', sans-serif;
            display: none;
            box-shadow: 0 0 5px #999999;
            position: absolute;
            max-width: 200px;
            top: 60px;
            left: 20px;
            padding: 10px;
            background-color: white;
        }

            .department-information .dept-name {
                color: #26a69a;
                font-weight: bold;
            }

            .department-information .dept-description {
                margin-top: 10px;
                color: #959b9a;
                font-size: 13px;
            }

            .department-information .dept-emp-count {
                margin-top: 10px;
                color: #959b9a;
                font-size: 13px;
            }

        /* ############################################## SVG ################################# */

        .nodeHasChildren {
            fill: white;
        }

        .nodeDoesNotHaveChildren {
            fill: white;
        }

        .nodeRepresentsCurrentUser {
            stroke: Chartreuse;
            stroke-width: 3;
        }

        text {
            fill: dimgray;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        .node {
            cursor: pointer;
        }

        .node-collapse {
            stroke: grey;
        }

        .node-collapse-right-rect {
            fill: #70c645;
            stroke: #70c645;
        }

        .node text {
            fill: white;
            font-family: "Segoe UI", Arial, sans-serif;
            font-size: 10px;
        }

        .node circle {
            stroke-width: 1px;
            stroke: #70c645;
            fill: #70c645;
        }

        .node-group .emp-name {
            fill: #962828;
            font-size: 12px;
            font-weight: 600
        }

        .node-group .emp-position-name {
            fill: #59525b;
            font-size: 11px;
        }

        .node-group .emp-area {
            fill: #91a4a5;
            font-size: 10px;
        }

        .node-group .emp-count,
        .node-group .emp-count-icon {
            fill: #91a4a5;
            font-size: 12px;
        }
    </style>






</head>

<body translate="no">

    <div id="full-container">

        <div class="department-information">
            <div class="dept-name">
                dept name
            </div>
            <div class="dept-emp-count">
                dept description test, this is department description
            </div>
            <div class="dept-description">
                dept description test, this is department description
            </div>
        </div>

        <div id="svgChart"></div>
    </div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>

    <script>
        var d3 = window.d3;

        var params = {
            selector: "#svgChart",
            dataLoadUrl: "https://raw.githubusercontent.com/bumbeishvili/Assets/master/Projects/D3/Organization%20Chart/redesignedChartLongData.json",
            chartWidth: window.innerWidth - 40,
            chartHeight: window.innerHeight - 40,
            funcs: {
            },
            data: null
        }

        d3.json(params.dataLoadUrl,
            function (data) {
                params.data = data;
                params.pristinaData = JSON.parse(JSON.stringify(data));

                drawOrganizationChart(params);
            });

        function drawOrganizationChart(params) {
            var attrs = {
                EXPAND_SYMBOL: '\uf067',
                COLLAPSE_SYMBOL: '\uf068',
                selector: params.selector,
                root: params.data,
                width: params.chartWidth,
                height: params.chartHeight,
                index: 0,
                nodePadding: 9,
                collapseCircleRadius: 7,
                nodeHeight: 80,
                nodeWidth: 210,
                duration: 750,
                rootNodeTopMargin: 20,
                minMaxZoomProportions: [0.05, 3],
                linkLineSize: 180,
                collapsibleFontSize: '10px',
                userIcon: '\uf007',
                nodeStroke: "#ccc",
                nodeStrokeWidth: '1px'
            }

            var dynamic = {}
            dynamic.nodeImageWidth = attrs.nodeHeight * 100 / 140;
            dynamic.nodeImageHeight = attrs.nodeHeight - 2 * attrs.nodePadding;
            dynamic.nodeTextLeftMargin = attrs.nodePadding * 2 + dynamic.nodeImageWidth
            dynamic.rootNodeLeftMargin = attrs.width / 2;
            dynamic.nodePositionNameTopMargin = attrs.nodePadding + 8 + dynamic.nodeImageHeight / 4 * 1;
            dynamic.nodeChildCountTopMargin = attrs.nodePadding + 14 + dynamic.nodeImageHeight / 4 * 3;

            var tree = d3.layout.tree().nodeSize([attrs.nodeWidth + 40, attrs.nodeHeight]);
            var diagonal = d3.svg.diagonal()
                .projection(function (d) {
                    return [d.x + attrs.nodeWidth / 2, d.y + attrs.nodeHeight / 2];
                });

            var zoomBehaviours = d3.behavior
                .zoom()
                .scaleExtent(attrs.minMaxZoomProportions)
                .on("zoom", redraw);

            var svg = d3.select(attrs.selector)
                .append("svg")
                .attr("width", attrs.width)
                .attr("height", attrs.height)
                .call(zoomBehaviours)
                .append("g")
                .attr("transform", "translate(" + attrs.width / 2 + "," + 20 + ")");

            //necessary so that zoom knows where to zoom and unzoom from
            zoomBehaviours.translate([dynamic.rootNodeLeftMargin, attrs.rootNodeTopMargin]);

            attrs.root.x0 = 0;
            attrs.root.y0 = dynamic.rootNodeLeftMargin;

            update(attrs.root);

            d3.select(attrs.selector).style("height", attrs.height);

            function update(source, param) {

                // Compute the new tree layout.
                var nodes = tree.nodes(attrs.root).reverse();
                var links = tree.links(nodes);

                // Normalize for fixed-depth.
                nodes.forEach(function (d) {
                    d.y = d.depth * attrs.linkLineSize;
                });

                // Update the nodes…
                var node = svg.selectAll("g.node").data(nodes,
                    function (d) {
                        return d.id || (d.id = ++attrs.index);
                    });

                // Enter any new nodes at the parent's previous position.
                var nodeEnter = node.enter()
                    .append("g")
                    .attr("class", "node")
                    .attr("transform",
                        function (d) {
                            return "translate(" + source.x0 + "," + source.y0 + ")";
                        });

                var nodeGroup = nodeEnter.append("g").attr("class", "node-group");

                nodeGroup.append("rect")
                    .attr("width", attrs.nodeWidth)
                    .attr("height", attrs.nodeHeight)
                    .attr("data-node-group-id", function (d) {
                        return d.uniqueIdentifier;
                    })
                    .attr("class", function (d) {
                        var res = "";
                        if (d.isLoggedUser) res += 'nodeRepresentsCurrentUser ';
                        res += d._children || d.children ? "nodeHasChildren" : "nodeDoesNotHaveChildren";
                        return res;
                    });

                nodeGroup.append("text")
                    .attr("x", dynamic.nodeTextLeftMargin)
                    .attr("y", attrs.nodePadding + 10)
                    .attr('class', 'emp-name')
                    .attr("text-anchor", "left")
                    .text(function (d) {
                        return d.name.trim();
                    });

                nodeGroup.append("text")
                    .attr("x", dynamic.nodeTextLeftMargin)
                    .attr("y", dynamic.nodePositionNameTopMargin)
                    .attr('class', 'emp-position-name')
                    .attr("dy", ".35em")
                    .attr("text-anchor", "left")
                    .text(function (d) {
                        var position = d.positionName.substring(0, 27);
                        if (position.length < d.positionName.length) {
                            position = position.substring(0, 24) + '...';
                        }
                        return position;
                    });

                nodeGroup.append("text")
                    .attr("x", dynamic.nodeTextLeftMargin)
                    .attr("y", attrs.nodePadding + 10 + dynamic.nodeImageHeight / 4 * 2)
                    .attr('class', 'emp-area')
                    .attr("dy", ".35em")
                    .attr("text-anchor", "left")
                    .text(function (d) {
                        return d.area;
                    });

                nodeGroup.append("text")
                    .attr("x", dynamic.nodeTextLeftMargin)
                    .attr("y", dynamic.nodeChildCountTopMargin)
                    .attr('class', 'emp-count-icon')
                    .attr("text-anchor", "left")
                    .style('font-family', 'FontAwesome')
                    .text(function (d) {
                        if (d.children || d._children) return attrs.userIcon;
                        else return "";
                    });

                nodeGroup.append("text")
                    .attr("x", dynamic.nodeTextLeftMargin + 13)
                    .attr("y", dynamic.nodeChildCountTopMargin)
                    .attr('class', 'emp-count')
                    .attr("text-anchor", "left")
                    .text(function (d) {
                        if (d.children) return d.children.length;
                        if (d._children) return d._children.length;
                        return 0;
                    });

                nodeGroup.append("defs").append("svg:clipPath")
                    .attr("id", "clip")
                    .append("svg:rect")
                    .attr("id", "clip-rect")
                    .attr("rx", 3)
                    .attr('x', attrs.nodePadding)
                    .attr('y', 2 + attrs.nodePadding)
                    .attr('width', dynamic.nodeImageWidth)
                    .attr('fill', 'none')
                    .attr('height', dynamic.nodeImageHeight - 4);

                nodeGroup.append("svg:image")
                    .attr('y', 2 + attrs.nodePadding)
                    .attr('x', attrs.nodePadding)
                    .attr('preserveAspectRatio', 'none')
                    .attr('width', dynamic.nodeImageWidth)
                    .attr('height', dynamic.nodeImageHeight - 4)
                    .attr('clip-path', "url(#clip)")
                    .attr("xlink:href",
                        function (v) {
                            return v.imageUrl;
                        });

                // Transition nodes to their new position.
                var nodeUpdate = node.transition()
                    .duration(attrs.duration)
                    .attr("transform",
                        function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });

                //todo replace with attrs object
                nodeUpdate.select("rect")
                    .attr("width", attrs.nodeWidth)
                    .attr("height", attrs.nodeHeight)
                    .attr('rx', 3)
                    .attr("stroke",
                        function (d) {
                            if (param && d.uniqueIdentifier === param.locate) return '#a1ceed';
                            else return attrs.nodeStroke;
                        })
                    .attr('stroke-width',
                        function (d) {
                            if (param && d.uniqueIdentifier === param.locate) return 6;
                            else return attrs.nodeStrokeWidth;
                        });

                // Transition exiting nodes to the parent's new position.
                var nodeExit = node.exit().transition()
                    .duration(attrs.duration)
                    .attr("transform", function (d) {
                        return "translate(" + source.x + "," + source.y + ")";
                    })
                    .remove();

                nodeExit.select("rect")
                    .attr("width", attrs.nodeWidth)
                    .attr("height", attrs.nodeHeight);

                // Update the links…
                var link = svg.selectAll("path.link")
                    .data(links, function (d) {
                        return d.target.id;
                    });

                // Enter any new links at the parent's previous position.
                link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("x", attrs.nodeWidth / 2)
                    .attr("y", attrs.nodeHeight / 2)
                    .attr("d", function (d) {
                        var o = {
                            x: source.x0,
                            y: source.y0
                        };
                        return diagonal({
                            source: o,
                            target: o
                        });
                    });

                // Transition links to their new position.
                link.transition()
                    .duration(attrs.duration)
                    .attr("d", diagonal);

                // Transition exiting nodes to the parent's new position.
                link.exit().transition()
                    .duration(attrs.duration)
                    .attr("d", function (d) {
                        var o = {
                            x: source.x,
                            y: source.y
                        };
                        return diagonal({
                            source: o,
                            target: o
                        });
                    })
                    .remove();

                // Stash the old positions for transition.
                nodes.forEach(function (d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });

                var x;
                var y;
                if (param && param.locate) {
                    nodes.forEach(function (d) {
                        if (d.uniqueIdentifier === param.locate) {
                            x = d.x;
                            y = d.y;
                        }
                    });

                    // normalize for width/height
                    var newX = (-x + (window.innerWidth / 2));
                    var newY = (-y + (window.innerHeight / 2));

                    // move the main container g
                    svg.attr("transform", "translate(" + newX + "," + newY + ")")
                    zoomBehaviours.translate([newX, newY]);
                    zoomBehaviours.scale(1);
                }

                if (param && param.centerMySelf) {
                    nodes.forEach(function (d) {
                        if (d.isLoggedUser) {
                            x = d.x;
                            y = d.y;
                        }

                    });

                    // normalize for width/height
                    var newX = (-x + (window.innerWidth / 2));
                    var newY = (-y + (window.innerHeight / 2));

                    // move the main container g
                    svg.attr("transform", "translate(" + newX + "," + newY + ")");
                    zoomBehaviours.translate([newX, newY]);
                    zoomBehaviours.scale(1);
                }
            }

            //########################################################

            //Redraw for zoom
            function redraw() {
                //console.log("here", d3.event.translate, d3.event.scale);
                svg.attr("transform",
                    "translate(" + d3.event.translate + ")" +
                    " scale(" + d3.event.scale + ")");
            }
        }
    </script>

</body>

</html>
